<html>

<head></head>

<body>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="amazon-cognito-identity.min.js"></script>
    <script src="aws-sdk.min.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
    
    <h3>상품정보</h3>
    <button onclick="callPublicApi()">공개 api호출</button>


    <br/>
    <br/>
    <h3>회원관리</h3>
    <div>
        <a id="login" href="https://phonecase.auth.ap-northeast-2.amazoncognito.com/login?response_type=token&client_id=gi18c058r50gup2clds7dk93q&redirect_uri=https://kanginhan.github.io/samplePage">로그인</a>
        <a id="logout" href="javascript:logout()">로그아웃</a>
    </div>

    <div>
        <label>id</label>
        <input type="text" id="id" disabled/>
    </div>
    <div>
        <label>name</label>
        <input type="text" id="name" disabled/>
    </div>
    <div>
        <label>phone</label>
        <input type="text" id="phone"/>
    </div>
    <div>
        <label>address</label>
        <input type="text" id="address"/>
    </div>
    <button onclick="userAttrSave()">속성 저장</button>
    


    <br/>
    <br/>
    <h3>주문</h3>




    
    <button onclick="requestPay()">결제 test</button>

    <script>
            var IMP = window.IMP; // 생략해도 괜찮습니다.
            IMP.init("imp83561466"); // "imp00000000" 대신 발급받은 "가맹점 식별코드"를 사용합니다.

            AWS.config.region = 'ap-northeast-2';

            var userInfo = null;
            var provider = new AWS.CognitoIdentityServiceProvider();
            var accessToken = getQueryToken("access_token") || getStoredToken("access_token");
            var idToken = getQueryToken("id_token") || getStoredToken("id_token");

            if(accessToken && idToken){
                localStorage.setItem('access_token', accessToken);
                localStorage.setItem('id_token', idToken);
                getUser();
            }else{
                $('#logout').hide();
            }


            function requestPay(){
                IMP.request_pay({ // param
                    pg: "uplus",
                    pay_method: "card",
                    merchant_uid: "ORD20180131-0000011",
                    name: "노르웨이 회전 의자",
                    amount: 64900,
                    buyer_email: "gildong@gmail.com",
                    buyer_name: "홍길동",
                    buyer_tel: "010-4242-4242",
                    buyer_addr: "서울특별시 강남구 신사동",
                    buyer_postcode: "01181"
                }, function (rsp) { // callback
                    if (rsp.success) {
                        
                    } else {
                        
                    }
                });
            }

            //로그아웃
            function logout(){
                localStorage.removeItem('access_token');
                localStorage.removeItem('id_token');
                location.href = "https://phonecase.auth.ap-northeast-2.amazoncognito.com/logout?client_id=gi18c058r50gup2clds7dk93q&logout_uri=https://kanginhan.github.io/samplePage";
            }

            //사용자속성 저장
            function userAttrSave(){
                if(!userInfo){
                    alert('로그인 해주세요');
                    return;
                }

                var param = {
                    AccessToken: accessToken,
                    UserAttributes: [ 
                        { 
                            Name: "phone_number",
                            Value:  $('#phone').val()
                        },
                        { 
                            Name: "address",
                            Value:  $('#address').val()
                        }
                    ]
                }
                provider.updateUserAttributes(param, function(err, data){
                    if(err){
                        //error
                    } else {
                        alert('속성 저장 성공');
                        location.reload();
                    }
                });
            }
    
            //사용자정보 조회
            function getUser(){
                var param = {
                    AccessToken: accessToken
                }
                provider.getUser(param, function (err, data) {
                    if(err){
                        //error
                        $('#logout').hide();
                    } else {
                        //success
                        $('#login').hide();
                        userInfo = data;

                        //id
                        $('#id').val(userInfo.Username);

                        //이름
                        var nameAttr = userInfo.UserAttributes.find(x => x.Name == "name");
                        if (nameAttr){
                            $('#name').val(nameAttr.Value);
                        }

                        //핸드폰
                        var phoneAttr = userInfo.UserAttributes.find(x => x.Name == "phone_number");
                        if (phoneAttr){
                            $('#phone').val(phoneAttr.Value);
                        }
                        //주소
                        var addressAttr = userInfo.UserAttributes.find(x => x.Name == "address");
                        if (addressAttr){
                            $('#address').val(addressAttr.Value);
                        }
                    }
                })
            }
    
            //url 해쉬 토큰 조회
            function getQueryToken(key){
                var hash = new URLSearchParams(window.location.hash);
                return hash.get(key) || hash.get('#' + key);
            }
            
            //저장된 토큰 조회
            function getStoredToken(key){
                return localStorage.getItem(key);
            }
    
            function callPublicApi() {
                $.ajax({
                    method: 'POST',
                    url: "https://wg2ncsll71.execute-api.ap-northeast-2.amazonaws.com/beta/getprodlist",
                    headers: {
                        "Accept": "*/*"
                    },
                    data: JSON.stringify({
                        "pd_category": "케이스",
                    }),
                    contentType: 'application/json',
                    success: function (result) {
                        alert(JSON.stringify(result));
                    },
                    error: function ajaxError(jqXHR, textStatus, errorThrown) {
    
                    }
                });
            }
        </script>
</body>

</html>
